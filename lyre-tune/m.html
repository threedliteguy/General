<html><body>
<canvas id="myc" width="2400" height="600"></canvas>
<br />
<div id="loudestfreq"></div>
<br />
<label for="mode">Mode</label>
<select name="mode" id="mode" >
  <option value="lydian">Lydian (church Ionian, mesopotamian nīd qabli)</option>
  <option value="phrygian">Phrygian (church Dorian, mesopotamian embūbu)</option>
  <option selected="selected" value="dorian">Dorian (church Phyrgian, mesopotamian išartu)</option>
  <option value="hypolydian">Hypolydian (church Lydian, mesopotamian nīš gabarî)</option>
  <option value="hypophrygian">Hypophrygian (church Mixolydian, mesopotamian pūtu)</option>
  <option value="hypodorian">Hypodorian/Locrian (church Aeolian, mesopotamian kitmu)</option>
  <option value="mixolydian">Mixolydian (church Locrian, mesopotamian qablītu)</option>
  <option value="just">Just intonation (5-limit from C, Ptolemy intense diatonic)</option>
  <option value="pythagorean">Pythagorean FCGDAEB</option>
  <option value="pentatonic_c">Pentatonic CDEGAC (Major, gong, Bhupali, Mohanam, MullaitheemPaaNi)</option>
  <option value="pentatonic_d">Pentatonic DEGACD (Suspended, shang, Megh, Madhyamavati, Sendhurutti)</option>
  <option value="pentatonic_e">Pentatonic EGACDE (Blues minor, jue, Malkauns, Hindolam, Indhalam)</option>
  <option value="pentatonic_g">Pentatonic GACDEG (Blues major, zhi, Durga, Shuddha Saveri, Konrai)</option>
  <option value="pentatonic_a">Pentatonic ACDEGA (Minor, yu, Dhani, Udayaravichandrika, Aambal)</option>
</select>

<label for="basenote">Set note </label>
<select name="basenote" id="basenote" >
  <option selected="selected" value="0">A</option>
  <option value="1">B</option>
  <option value="2">C</option>
  <option value="3">D</option>
  <option value="4">E</option>
  <option value="5">F</option>
  <option value="6">G</option>
</select>
<label for="basenotehz">to Hz</label>
<input type="text" name="basenotehz" id="basenotehz" value="432" size=5 ></input>
<label for="octave">Add octaves</label>
<select name="octave" id="octave" >
  <option value="-2">-2</option>
  <option value="-1">-1</option>
  <option selected="selected" value="0">0</option>
  <option value="1">1</option>
  <option value="2">2</option>
</select>
<br/>
<button onclick='javascript:changemode();'>Update frequencies:</button>
<label id="freqs"></label>


<script>
const WIDTH=2400;
const HEIGHT=600;


// Tuning 7 string lyre for Ancient Greek modes by alternating ascending or descending fifths and fourths:
// https://www.reddit.com/r/lyres/comments/kntcxl/method_for_tuning_a_sevenstring_lyre_by_ear_a/
// https://youtu.be/Yk6bLMe2Uak?t=318
// https://pages.mtu.edu/~suits/fifths.html

// https://en.wikipedia.org/wiki/Just_intonation
// https://en.wikipedia.org/wiki/Pythagorean_tuning
// https://en.wikipedia.org/wiki/Pentatonic_scale


// This program will help do it visually instead of by ear.

// Mesopotamian names:
// https://en.wikipedia.org/wiki/Music_of_Mesopotamia
// https://www.flutopedia.com/mesopotamian_flutes.htm
// https://books.google.com/books?id=eliIDwAAQBAJ&lpg=PA30&ots=41IchPISlq&dq=qabl%C4%ABtu&pg=PA40#v=onepage&q&f=false



var magnify = 10;
var num_add_octaves_to_mode_lines = 0;

// 440 HZ is conventional for A above middle C.  432 may be preferred for just intonation. 11 is largest prime factor for 440, while 3 is largest for 432.
// Standard middle C is 261.63 Hz

var middle_c = 261.63;

var base_note = 0; 
var base_note_hz = 1;
var adj_base_note_hz = base_note_hz;


const unison = 1.0;
const octave = 2.0;

const fifth = 3.0/2.0;
const fourth = 4.0/3.0;
const desc_fifth = 2.0/3.0;
const desc_fourth = 3.0/4.0;

const tn = [[desc_fourth,fifth],[desc_fifth,fourth]];


// Names per above reddit chart.
const modes = new Map();
modes.set('lydian', [[0,1,0,1,0,1],5,0,0]);
modes.set('phrygian', [[1,0,0,1,0,1],4,0,0]);
modes.set('dorian', [[1,0,1,0,0,1],3,0,0]);
modes.set('hypolydian', [[1,0,1,0,1,0],2,0,0]);
modes.set('hypophrygian', [[1,0,1,0,1,1],1,1,0]);
modes.set('hypodorian', [[1,0,1,1,0,1],0,1,0]);
modes.set('mixolydian', [[1,1,0,1,0,1],6,1,0]);

modes.set('just', [[1.0,9/8,5/4,4/3,3/2,5/3,15/8],5,0,1]);

modes.set('pythagorean', [[32/27,16/9,4/3,1.0,3/2,9/8,27/16],4,0,2]);

modes.set('pentatonic_c', [[1.0,27/24,30/24,36/24,40/24,48/24],4,0,2]);
modes.set('pentatonic_d', [[1.0,27/24,32/24,36/24,42/24,48/24],3,0,2]);
modes.set('pentatonic_e', [[1.0,18/15,20/15,24/15,27/15,30/15],2,0,2]);
modes.set('pentatonic_g', [[1.0,27/24,32/24,36/24,40/24,48/24],1,0,2]);
modes.set('pentatonic_a', [[1.0,36/30,40/30,45/30,54/30,60/30],0,0,2]);

var freqs = [];


// Draw:
var grid = [100,200,300,400,500,600,700,800,900,1000];


var divloudestfreq = document.getElementById("loudestfreq");
var divfreqs = document.getElementById("freqs");
var canvas = document.getElementById("myc");
var canvasCtx = canvas.getContext("2d");


function changemode() {
 
 base_note = Number(document.getElementById("basenote").value);
 base_note_hz = Number(document.getElementById("basenotehz").value);
 num_add_octaves_to_mode_lines = document.getElementById("octave").value;

 var selectedmode = document.getElementById("mode").value;
 console.log('selectedmode = '+selectedmode)
 var a = modes.get(selectedmode);
 
 const pattern = a[0];
 const a_index = a[1];  // what string is A, starting with 0
 const type = a[2]; // ascending fourth or fifth
 const other = a[3]; // kind of pattern: fifths pattern or ratios (sequential or non)
 
 console.log('pattern = ' + pattern + ' a_index = ' + a_index + ' type = '+type+' other = '+other);

 // Compute frequencies

 var spacings = [1.0];
 
 if (other == 0) {
   for (let t=0;t<pattern.length;t++){
     spacings.push(spacings[spacings.length-1]*tn[type][pattern[t]]);
   }
 } else {
   spacings = pattern;
 }

 var basenote_element = document.getElementById("basenote");
 if (other == 2) {
   base_note = 0;
   basenote_element.value = base_note;
   basenote_element.disabled = true;
 } else {
   basenote_element.disabled = false;
 }
 var relativeto = (a_index + base_note) % 7;  // Can't use modulo on non-sequential scales, so base_note has to be A

 console.log(spacings);
 spacings.sort()
 console.log(spacings);

 adj_base_note_hz = base_note_hz * (octave ** num_add_octaves_to_mode_lines);
 console.log('base note hz  = '+base_note_hz);
 console.log('adj base note hz = '+adj_base_note_hz);

 freqs = [];
 console.log('a_index = '+a_index);
 console.log('base_note = '+base_note);
 
 console.log('relativeto = '+relativeto);
 const a_adj = spacings[relativeto];
 for (let t=0;t<spacings.length;t++){
     var f = spacings[t] * adj_base_note_hz / a_adj;
     f = Math.round(f*100)/100; 
     freqs.push(f);
 }
 console.log(freqs);
 freqs.sort();
 console.log(freqs);

 canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
 divfreqs.innerHTML = `${freqs}`

}


// Audio:
// https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode/getByteFrequencyData
// https://stackoverflow.com/questions/28329389/is-there-a-way-to-detect-audio-frequency-in-html-5-web-audio-api


navigator.mediaDevices.getUserMedia({audio:true}).then(function(localStream) {

  var audioContext = new(window.AudioContext || window.webkitAudioContext)();
  
  var sampleRate = audioContext.sampleRate;
  console.log('sample rate = '+ sampleRate);
  
  
  // https://github.com/hughsk/clamp/blob/master/index.js [MIT license]
  function clamp(value, min, max) {
  return min < max
    ? (value < min ? min : value > max ? max : value)
    : (value < max ? max : value > min ? min : value)
  }
  
  // https://github.com/Jam3/audio-frequency-to-index/blob/master/index.js [MIT license]
  function indexToFrequency (index, sampleRate, frequencyBinCount) {
    return index * sampleRate / (frequencyBinCount * 2);
  }
  function frequencyToIndex (frequency, sampleRate, frequencyBinCount) { 
    var nyquist = sampleRate / 2;
    var index = Math.round(frequency / nyquist * frequencyBinCount);
    return clamp(index, 0, frequencyBinCount);
  }

  var input = audioContext.createMediaStreamSource(localStream);
  var scriptProcessor = audioContext.createScriptProcessor();
  
  var analyser = audioContext.createAnalyser();

  analyser.fftSize = 16384*2;

  input.connect(analyser);
  analyser.connect(scriptProcessor);
  scriptProcessor.connect(audioContext.destination);

  const frequencyBinCount = analyser.frequencyBinCount;
  console.log('frequencyBinCount = '+frequencyBinCount);
  
  var dataArray = new Uint8Array(frequencyBinCount*2);

  const drawscale = WIDTH/frequencyBinCount * magnify;
  const barWidth = drawscale ;
  console.log('barWidth = '+barWidth);

  
  function draw() {
    drawVisual = requestAnimationFrame(draw);

    analyser.getByteFrequencyData(dataArray);

    canvasCtx.fillStyle = "rgb(0, 0, 0)";
    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
    
    canvasCtx.fillStyle = "rgb(0, 0, 200)";
    for (let h = 0; h < grid.length; h++) {
       canvasCtx.fillRect(drawscale*frequencyToIndex(grid[h], sampleRate, frequencyBinCount), 0, barWidth*.25, HEIGHT);
    } 
    canvasCtx.fillStyle = "rgb(256, 256, 0)";
    for (let h = 0; h < freqs.length; h++) {
       canvasCtx.fillRect(drawscale*frequencyToIndex(freqs[h], sampleRate, frequencyBinCount), 0, barWidth*.5, HEIGHT);
    } 
    canvasCtx.fillStyle = "rgb(256, 256, 256)";
    canvasCtx.fillRect(drawscale*frequencyToIndex(adj_base_note_hz, sampleRate, frequencyBinCount), 0, barWidth*.5, HEIGHT);
    
    let barHeight;
    let x = 0;
    let mi = 0;
    let mv = 0;

    for (let i = 0; i < frequencyBinCount; i++) {
    
      barHeight = dataArray[i];
      if (barHeight>mv) {mv = barHeight;mi=i;}
    
      canvasCtx.fillStyle = `rgb(${barHeight + 100}, 200, 200)`;
      canvasCtx.fillRect(drawscale*i, HEIGHT - barHeight , barWidth, barHeight );

    }
    
  
    peakhz = Math.round(indexToFrequency(mi, sampleRate, frequencyBinCount));
    divloudestfreq.innerHTML = `${peakhz}`
  }

  changemode();
  draw();
 
});
 
 
 
</script>
</body></html>

