<html><body>
<canvas id="myc" width="2400" height="600"></canvas>
<br />
<div id="loudestfreq"></div>
<br />
<label for="mode">Mode</label>
<select name="mode" id="mode" onchange="javascript:changemode();">
  <option value="lydian">Lydian (church Ionian, mesopotamian nīd qabli)</option>
  <option value="phrygian">Phrygian (church Dorian, mesopotamian embūbu)</option>
  <option selected="selected" value="dorian">Dorian (church Phyrgian, mesopotamian išartu)</option>
  <option value="hypolydian">Hypolydian (church Lydian, mesopotamian nīš gabarî)</option>
  <option value="hypophrygian">Hypophrygian (church Mixolydian, mesopotamian pūtu)</option>
  <option value="hypodorian">Hypodorian/Locrian (church Aeolian, mesopotamian kitmu)</option>
  <option value="mixolydian">Mixolydian (church Locrian, mesopotamian qablītu)</option>
</select>
<label for="octave">Octave</label>
<select name="octave" id="octave" onchange="javascript:changeoctave();">
  <option value="-1">-1</option>
  <option selected="selected" value="0">0</option>
  <option value="1">1</option>
</select>
<div id="freqs"></div>


<script>
const WIDTH=2400;
const HEIGHT=600;


// Tuning 7 string lyre for Ancient Greek modes by alternating ascending fifths and descending fourths:
// https://youtu.be/Yk6bLMe2Uak?t=318
// https://www.reddit.com/r/lyres/comments/kntcxl/method_for_tuning_a_sevenstring_lyre_by_ear_a/
// This program will help do it visually instead of by ear.

// Mesopotamian names:
// https://en.wikipedia.org/wiki/Music_of_Mesopotamia
// https://www.flutopedia.com/mesopotamian_flutes.htm
// https://books.google.com/books?id=eliIDwAAQBAJ&lpg=PA30&ots=41IchPISlq&dq=qabl%C4%ABtu&pg=PA40#v=onepage&q&f=false



var magnify = 10;
var num_add_octaves_to_mode_lines = 0;

//var base_anote = 440; // HZ conventional A above middle C
var base_anote = 432; // may be preferred for just intonation. 11 is largest prime factor for 440, while 3 is largest for 432.
var anote = base_anote;


const unison = 1.0;
const octave = 2.0;

const fifth = 3.0/2.0;
const fourth = 4.0/3.0;
const desc_fourth = 3.0/4.0;

const tn = [desc_fourth,fifth];

// Names per above reddit chart.
const modes = new Map();
modes.set('lydian', [[0,1,0,1,0,1],4]);
modes.set('phrygian', [[1,0,0,1,0,1],4]);
modes.set('dorian', [[1,0,1,0,0,1],4]);
modes.set('hypolydian', [[1,0,1,0,1,0],4]);
modes.set('hypophrygian', [[1,0,1,0,1,1],2]);
modes.set('hypodorian', [[1,0,1,1,0,1],2]);
modes.set('mixolydian', [[1,1,0,1,0,1],2]);

var freqs = [];


// Draw:
var grid = [100,200,300,400,500,600,700,800,900,1000];


var divloudestfreq = document.getElementById("loudestfreq");
var divfreqs = document.getElementById("freqs");
var canvas = document.getElementById("myc");
var canvasCtx = canvas.getContext("2d");

// Select octave
function changeoctave() {

  num_add_octaves_to_mode_lines = document.getElementById("octave").value;
  changemode();

}

// Select mode
function changemode() {
 
 // Mode definitions

 var selectedmode = document.getElementById("mode").value;
 console.log('selectedmode = '+selectedmode)
 var a = modes.get(selectedmode);
 
 const pattern = a[0];
 const a_index = a[1];  // e.g. 3 means A is fourth note, starting with E, on the reddit tuning chart.
 console.log('pattern = ' + pattern + ' a_index = ' + a_index);

 // Compute frequencies

 const spacings = [1.0];
 for (let t=0;t<pattern.length;t++){
   spacings.push(spacings[spacings.length-1]*tn[pattern[t]]);
 }

 console.log(spacings);


 anote = base_anote * (octave ** num_add_octaves_to_mode_lines);
 console.log('anote = '+anote);

 freqs = [];
 const a_adj = spacings[a_index];
 for (let t=0;t<spacings.length;t++){
     var f = spacings[t] * anote / a_adj;
     f = Math.round(f*100)/100; 
     freqs.push(f);
 }
 console.log(freqs);
 freqs.sort();
 console.log(freqs);

 canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
 divfreqs.innerHTML = `${freqs}`

}


// Audio:
// https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode/getByteFrequencyData
// https://stackoverflow.com/questions/28329389/is-there-a-way-to-detect-audio-frequency-in-html-5-web-audio-api


navigator.mediaDevices.getUserMedia({audio:true}).then(function(localStream) {

  var audioContext = new(window.AudioContext || window.webkitAudioContext)();
  
  var sampleRate = audioContext.sampleRate;
  console.log('sample rate = '+ sampleRate);
  
  
  // https://github.com/hughsk/clamp/blob/master/index.js [MIT license]
  function clamp(value, min, max) {
  return min < max
    ? (value < min ? min : value > max ? max : value)
    : (value < max ? max : value > min ? min : value)
  }
  
  // https://github.com/Jam3/audio-frequency-to-index/blob/master/index.js [MIT license]
  function indexToFrequency (index, sampleRate, frequencyBinCount) {
    return index * sampleRate / (frequencyBinCount * 2);
  }
  function frequencyToIndex (frequency, sampleRate, frequencyBinCount) { 
    var nyquist = sampleRate / 2;
    var index = Math.round(frequency / nyquist * frequencyBinCount);
    return clamp(index, 0, frequencyBinCount);
  }

  var input = audioContext.createMediaStreamSource(localStream);
  var scriptProcessor = audioContext.createScriptProcessor();
  
  var analyser = audioContext.createAnalyser();

  //analyser.fftSize = 256;
  analyser.fftSize = 16384*2;

  input.connect(analyser);
  analyser.connect(scriptProcessor);
  scriptProcessor.connect(audioContext.destination);
  //scriptProcessor.onaudioprocess = onAudio;

  const frequencyBinCount = analyser.frequencyBinCount;
  console.log('frequencyBinCount = '+frequencyBinCount);
  
  var dataArray = new Uint8Array(frequencyBinCount*2);

  const drawscale = WIDTH/frequencyBinCount * magnify;
  const barWidth = drawscale ;
  console.log('barWidth = '+barWidth);

  
  function draw() {
    drawVisual = requestAnimationFrame(draw);

    analyser.getByteFrequencyData(dataArray);

    canvasCtx.fillStyle = "rgb(0, 0, 0)";
    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
    
    canvasCtx.fillStyle = "rgb(0, 0, 200)";
    for (let h = 0; h < grid.length; h++) {
       canvasCtx.fillRect(drawscale*frequencyToIndex(grid[h], sampleRate, frequencyBinCount), 0, barWidth*.25, HEIGHT);
    } 
    canvasCtx.fillStyle = "rgb(256, 256, 0)";
    for (let h = 0; h < freqs.length; h++) {
       canvasCtx.fillRect(drawscale*frequencyToIndex(freqs[h], sampleRate, frequencyBinCount), 0, barWidth*.5, HEIGHT);
    } 
    canvasCtx.fillStyle = "rgb(256, 256, 256)";
    canvasCtx.fillRect(drawscale*frequencyToIndex(anote, sampleRate, frequencyBinCount), 0, barWidth*.5, HEIGHT);
    
    let barHeight;
    let x = 0;
    let mi = 0;
    let mv = 0;

    for (let i = 0; i < frequencyBinCount; i++) {
    
      barHeight = dataArray[i];
      if (barHeight>mv) {mv = barHeight;mi=i;}
    
      canvasCtx.fillStyle = `rgb(${barHeight + 100}, 200, 200)`;
      canvasCtx.fillRect(drawscale*i, HEIGHT - barHeight , barWidth, barHeight );

    }
    
  
    peakhz = Math.round(indexToFrequency(mi, sampleRate, frequencyBinCount));
    divloudestfreq.innerHTML = `${peakhz}`
  }

  changemode();
  draw();
 
});
 
 
 
</script>
</body></html>

