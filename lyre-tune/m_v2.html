<!-- 

(c) 2022 Dan Meany   
License: MIT (free open source)  

Note: This file should be run as a locally saved file, or else served from an https url.  
Serving from an http url (insecure context) will not work due to browser security restrictions.

-->
<html>
<head>
<link rel="stylesheet" href="m.css">
</head>
<body>
<canvas id="myc" width="9000" height="600"></canvas>
<br />
<div id="loudestfreq"></div>
<br />
<label for="octave">Number of strings:</label>
<select name="strings" id="strings" >
  <option selected="selected" value="7">7</option>
  <option value="8">8</option>
  <option value="9">9</option>
  <option value="10">10</option>
  <option value="11">11</option>
  <option value="12">12</option>
  <option value="13">13</option>
  <option value="24">24</option>
</select>
<label for="highlimit">Highest string capable note limit:</label><!-- Values fixed based on standard A4 -->
<select name="highlimit" id="highlimit" >
  <option value="-14">A2</option>
  <option value="-13">B2</option>
  <option value="-12">C3</option>
  <option value="-11">D3</option>
  <option value="-10">E3</option>
  <option value="-9">F3</option>
  <option value="-8">G3</option>
  <option value="-7">A3</option>
  <option value="-6">B3</option>
  <option value="-5">C4</option>
  <option value="-4">D4</option>
  <option value="-3">E4</option>
  <option value="-2">F4</option>
  <option value="-1">G4</option>
  <option value="0">A4</option>
  <option value="1">B4</option>
  <option selected="selected" value="2">C5</option>
  <option value="3">D5</option>
  <option value="4">E5</option>
  <option value="5">F5</option>
  <option value="6">G5</option>
  <option value="7">A5</option>
  <option value="8">B5</option>
  <option value="9">C6</option>
  <option value="10">D6</option>
  <option value="11">E6</option>
  <option value="12">F6</option>
  <option value="13">G6</option>
  <option value="14">A6</option>
  <option value="15">B6</option>
</select>
<br /><br />

<label for="first_note">First Note</label>
<select name="first_note" id="first_note" >
<option selected="selected" value="C">C</option>
<option value="D">D</option>
<option value="E">E</option>
<option value="F">F</option>
<option value="G">G</option>
<option value="A">A</option>
<option value="B">B</option>
</select>

<label for="octave">Add octaves</label>
<select name="octave" id="octave" >
  <option value="3">3</option>
  <option value="2">2</option>
  <option value="1">1</option>
  <option selected="selected" value="0">0</option>
  <option value="-1">-1</option>
  <option value="-2">-2</option>
  <option value="-3">-3</option>
</select>

<br /><br />
<br /><br />
<label for="type">Type</label>
<select name="type" id="type" onchange='changetype();'>
  <option value="genres">Genres</option>
  <option selected="selected" value="modes">Modes</option>
</select>
<br /><br />

<script>
function changetype() {
  var type = document.getElementById("type").value;
  if (type == "genres") {
    document.getElementById("div_species").style.display="none";
    document.getElementById("div_genus").style.display="block";
  } else {
    document.getElementById("div_species").style.display="block";
    document.getElementById("div_genus").style.display="none";
  }
}
</script>
<div id="div_species" style="display:block">
<label for="species">Species</label>
<select name="species" id="species" >
  <option value="mixolydios">Greek Mixolydios, modern Locrian, Mesopotamian qablītu</option>
  <option value="hypodorios">Greek Hypodorios/Locrian, modern Aeolian, Mesopotamian kitmu</option>
  <option value="lydios">Greek Lydios, modern Ionian, Mesopotamian nīd qabli</option>
  <option value="phrygios">Greek Phrygios, modern Dorian, Mesopotamian embūbu</option>
  <option value="dorios">Greek Dorios, modern Phyrgian, Mesopotamian išartu</option>
  <option value="hypolydios">Greek Hypolydios, modern Lydian, Mesopotamian nīš gabarî</option>
  <option value="hypophrygios">Greek Hypophrygios, modern Mixolydian, Mesopotamian pūtu</option>
</select>
</div>
<div id="div_genus" style="display:none">
<label for="genus">Genus</label>
<select name="genus" id="genus" >
<option selected="selected" value="diatonic">Diatonic</option>
<option value="chromatic">Chromatic</option>
<option value="enharmonic">Enharmonic</option>
</select>
</div>
<br /><br />
<label for="intonation">Intonation</label>
<select name="intonation" id="intonation" >
<option selected="selected" value="equal">Equal</option>
<!--<option value="just">Just</option>-->
</select>

<br /><br />
<br /><br />
<button onclick='javascript:changemode();'>Update frequencies:</button>
<label id="freqs"></label>
<br /><br />

<script>
const WIDTH=8000;
const HEIGHT=600;


// Tuning 7 string lyre for Ancient Greek modes by alternating ascending or descending fifths and fourths:
// https://www.reddit.com/r/lyres/comments/kntcxl/method_for_tuning_a_sevenstring_lyre_by_ear_a/
// https://youtu.be/Yk6bLMe2Uak?t=318
// https://pages.mtu.edu/~suits/fifths.html

// https://en.wikipedia.org/wiki/Just_intonation
// http://www.tonalsoft.com/enc/j/just.aspx
// https://en.wikipedia.org/wiki/Pythagorean_tuning
// https://en.wikipedia.org/wiki/Pentatonic_scale



// This program will help do it visually instead of by ear.

// Mesopotamian names:
// https://en.wikipedia.org/wiki/Music_of_Mesopotamia
// https://www.flutopedia.com/mesopotamian_flutes.htm
// https://books.google.com/books?id=eliIDwAAQBAJ&lpg=PA30&ots=41IchPISlq&dq=qabl%C4%ABtu&pg=PA40#v=onepage&q&f=false



var divloudestfreq = document.getElementById("loudestfreq");
var divfreqs = document.getElementById("freqs");
var canvas = document.getElementById("myc");
var canvasCtx = canvas.getContext("2d");
var freqs = [];

var magnify = 5;
var num_add_octaves_to_mode_lines = 0;

var TET_12 = 2 ** (1/12);
var TET_24 = 2 ** (1/24);

var standard_a4 = 440;
var standard_c4 = 261.63;
var high_limit_hz = 0;
var strings = 1;

const unison = 1.0;
const octave = 2.0;


// f.length must span exactly a complete octave and be able to be shifted up an octave for this to work (e.g. no Pythagorean comma)
function extend(frequencies_set, strings) {
  for (n = 0; n < frequencies_set.length; n++) {
    f = frequencies_set[n];
    var b = f.length;
    for (let i = b; i < strings; i++) {
        f.push(f[i % b]*(octave**Math.floor(i/b)));
    }
    frequencies_set[n] = f;
  }
  return frequencies_set;
}



function changemode() {

 num_add_octaves_to_mode_lines = Number(document.getElementById("octave").value) - 1;
 strings = Number(document.getElementById("strings").value);

 var scale_type = document.getElementById("type").value;
 var selectedscale = (scale_type == "genres") ? document.getElementById("genus").value : document.getElementById("species").value ;
 console.log('selectedscale = '+selectedscale);
 var first_note = document.getElementById("first_note").value;
 var first_note_accidental = "";
 var first = first_note + first_note_accidental;
 console.log('first = '+first);
 var scale_data = source_tables.filter(function (t) { return t[0] == selectedscale; })[0];
 console.log('scale_data = '+scale_data);
 var scale = scale_data[1].filter(function (t) { return t.split(" ")[0] == first; })[0];
 console.log('scale = '+scale);



 // TODO see below ---------
 // Ratios for equal tempered
 var semis = [2,1,2,2,1,2,2]; // starting at A 
 var equiratios = [1.0];
 var semisup = 0;
 for (let n = 0; n < 7*2; n++) {
     semisup = semisup + semis[n % 7];
     equiratios.push(TET_12 ** (semisup));
 }
 console.log('equiratios = '+equiratios);
 // Handle high limit indicator 
 var high_limit_selection = Number(document.getElementById("highlimit").value); 
 var high_limit_octave = Math.floor(high_limit_selection / 7.0);
 console.log('high_limit_octave = '+high_limit_octave);
 var high_limit_note = (high_limit_selection+7*7) % 7; 
 console.log('high_limit_note = '+high_limit_note);
 high_limit_hz = standard_a4 * equiratios[high_limit_note] * (octave ** high_limit_octave);
 console.log('high_limit_hz = '+high_limit_hz);
 // TODO fix above code for high limit to same ratio array  ---------



 // Quarter tone equal temperment
 tet_24_ratios = [];
 for (let n = 0; n < 24; n++) {
   tet_24_ratios.push(TET_24 ** n);
 } 

 // Ratios for just // TODO
 var justratios = [1.0,0,9/8,0,5/4,0,4/3,0,3/2,0,5/3,0,15/8,0]; // TODO need how to get semitone/quarter tone ratios for just
 console.log('justratios = '+justratios);
 
 var intonation = document.getElementById("intonation").value;
 var ratios = intonation == "equal" ? tet_24_ratios : justratios;
 console.log('selected ratios = '+ratios);


 // Compute frequencies

 function frequency_of_note(note, ratios, current_octave) {
    var n = note.substring(0,1);
    var semitones_from_a = "A BC D EF G".indexOf(n);
    var quarter_tones_from_a = semitones_from_a * 2;
    var s = note.substring(1);
    if (s.startsWith("#")) quarter_tones_from_a = quarter_tones_from_a + 2;
    if (s.startsWith("b")) quarter_tones_from_a = quarter_tones_from_a - 2;
    if (s.endsWith("*")) quarter_tones_from_a = quarter_tones_from_a + 1; 
    var use_octave = current_octave;
    if (quarter_tones_from_a < 0) { quarter_tones_from_a = 24 + quarter_tones_from_a; use_octave = current_octave - 1;} // e.g. A-flat
    var r = ratios[quarter_tones_from_a];
   
    var f = standard_a4 * r * (octave ** use_octave);
    console.log("frequency_of_note",note,current_octave,f);
    return f;
 }
 
 freqs = [];
 var scale_notes = scale.split(" ");
 console.log(scale_notes);
 var current_octave = num_add_octaves_to_mode_lines;
 for (let i = 0; i < scale_notes.length; i++) {
    var note = scale_notes[i];
    if (i>0 && note.substring(0,1) < scale_notes[i-1].substring(0,1)) current_octave++;
    var f = frequency_of_note(note, ratios, current_octave);
    freqs.push(f);
 }
 console.log(freqs);
 freqs = freqs.slice(0,strings);
 console.log(freqs);

 canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
 divfreqs.innerHTML = `${freqs}`

}


// Source tables from Nikolaos Koumartzis
var source_tables = [
["diatonic", [
"C Db Eb F Gb Ab Bb B Db Eb E F# G# A B C# D E F# G A B C D",
"D Eb F G Ab Bb C Db Eb F Gb Ab Bb B Db Eb E F# G# A B C# D E",
"E F G A Bb C D Eb F G Ab Bb C Db Eb F Gb Ab Bb B Db Eb E F#",
"F Gb Ab Bb B Db Eb E F# G# A B C# D E F# G A B C D E F G",
"G Ab Bb C Db Eb F Gb Ab Bb B Db Eb E F# G# A B C# D E F# G A",
"A Bb C D Eb F G Ab Bb C Db Eb F Gb Ab Bb B Db Eb E F# G A B",
"B C D E F G A Bb C D Eb F G Ab Bb C Db Eb F Gb Ab Bb B Db"
]],
["chromatic", [
"C C# D F F# G Bb B C Eb E F Ab A Bb Db D D# F# G G# B C C#",
"D D# E G G# A C C# D F F# G Bb B C Eb E F Ab A Bb Db D D#",
"E F F# A Bb B D D# E G G# A C C# D F F# G Bb B C Eb E F",
"F F# G Bb B C Eb E F Ab A Bb B D D# E G G# A C C# D F F#",
"G G# A C C# D F F# G Bb B C Eb E F Ab A Bb Db D D# F# G G#",
"A A# B D D# E G G# A C C# D F F# G Bb B C Eb E F Ab A Bb",
"B C C# E F F# A Bb B D D# E G G# A C C# D F F# G Bb B C"
]],
["enharmonic", [
"C C* C# F F* F# A# A#* B D# D#* Ε G# G#* A C# C#* D F# F#* G B B* C",
"D D* D#* G G* G#* C C* C# F F* F# A# A#* B D# D#* Ε G# G#* A C# C#* D",
"E E* F A A* A# D D* D#* G G* G#* C C* C# F F* F# A# A#* B D# D#* Ε",
"F F* F# A# A#* B D# D#* E G# G#* A C# C#* D F# F#* G B B* C E E* F",
"G G* G#* C C* C# F F* F# A# A#* B D# D#* Ε G# G#* A C# C#* D F# F#* G",
"A A* A# D D* D#* G G* G#* C C* C# F F* F# A# A#* B D# D#* Ε G# G#* A",
"B B* C E E* F A A* A# D D* D#* G G* G#* C C* C# F F* F# A# A#* B"
]],
["mixolydios", [
"B C D E F G A B C D E F G A B C D E F G A B C D",
"C Db Eb F Gb Ab Bb C Db Eb F Gb Ab Bb C Db Eb F Gb Ab Bb C Db Eb",
"D Eb F G Ab Bb C D Eb F G Ab Bb C D Eb F G Ab Bb C D Eb F",
"E F G A Bb C D E F G A Bb C D E F G A Bb C D E F G",
"F Gb Ab Bb Cb Db Eb F Gb Ab Bb Cb Db Eb F Gb Ab Bb Cb Db Eb F Gb Ab",
"G Ab Bb C Db Eb F G Ab Bb C Db Eb F G Ab Bb C D Eb F G Ab Bb",
"A Bb C D Eb F G A Bb C D Eb F G A Bb C D Eb F G A Bb C"
]],
["hypodorios", [
"A B C D E F G A B C D E F G A B C D E F G A B C",
"B C# D E F# G A B C# D E F# G A B C# D E F# B C# D",
"C D Eb F G Ab Bb C D Eb F G Ab Bb C D Eb F G Ab Bb C D Eb",
"D E F G A Bb C D E F G A Bb C D E F G A Bb C D E F",
"E F# G A B C D E F# G A B C D E F# G A B C D E F# G",
"F G Ab Bb C Db Eb F G Ab Bb C Db Eb F G Ab Bb C Db Eb F G Ab",
"G A Bb C D Eb F G A Bb C D Eb F G A Bb C D Eb F G A Bb"
]],
["lydios", [
"C D E F G A B C D E F G A B C D E F G A B C D E",
"D E F# G A B C# D E F# G A B C# D E F# G A B C D E F#",
"E F# G# A B C# D# E F# G# A B C# D# E F# G# A B C# D# E F# G#",
"F G A Bb C D E F G A Bb C D E F G A Bb C D E F G A",
"G A B C D E F# G A B C D E F# G A B C D E F# G A B",
"A B C# D E F# G# A B C# D E F# G# A B C# D E F# G# A B C#",
"B C# D# E F# G# A# B C# D# E F# G# A# B C# D# E F# G# A# B C# D#"
]],
["phrygios", [
"D E F G A B C D E F G A B C D E F G A B C D E F",
"E F# G A B C# D E F# G A B C# D E F# G A B C# D E F# G",
"F G Ab Bb C D Eb F G Ab Bb C D Eb F G Ab Bb C D Eb F G Ab",
"G A Bb C D E F G A Bb C D E F G A Bb C D E F G A Bb",
"A B C D E F# G A B C D E F# G A B C D E F# G A B C",
"B C# D E F# G# A B C# D E F# G# A B C# D E F# G# A B C# D",
"C D Eb F G A Bb C D Eb F G A Bb C D Eb F G A Bb C D Eb"
]],
["dorios", [
"E F G A B C D E F G A B C D E F G A B C D E F G",
"F Gb Ab Bb C Db Eb F Gb Ab Bb C Db Eb F Gb Ab Bb C Db Eb F Gb Ab",
"G Ab Bb C D Eb F G Ab Bb C D Eb F G Ab Bb C D Eb F G Ab Bb",
"A Bb C D E F G A Bb C D E F G A Bb C D E F G A Bb C",
"B C D E F# G A B C D E F# G A B C D E F# G A B C D",
"C Db Eb F G Ab Bb C Db Eb F G Ab Bb C Db Eb F G Ab Bb C Db Eb",
"D Eb F G A Bb C D Eb F G A Bb C D Eb F G A Bb C D Eb F"
]],
["hypolydios", [
"F G A B C D E F G A B C D E F G A B C D E F G A",
"G A B C# D E F# G A B C# D E F# G A B C# D E F# G A B",
"A B C# D# E F# G# A B C# D# E F# G# A B C# D# E F# G# A B C#",
"B C# D# E# F# G# A# B C# D# E# F# G# A# B C# D# E# F# G# A# B C# D#",
"C D E F# G A B C D E F# G A B C D E F# G A B C D E",
"D E F# G# A B C# D E F# G# A B C# D E F# G# A B C# D E F#",
"E F# G# A# B C# D# E F# G# A# B C# D# E F# G# A# B C# D# E F# G#"
]],
["hypophrygios", [
"G A B C D E F G A B C D E F G A B C D E F G A B",
"A B C# D E F# G A B C# D E F# G A B C# D E F# G A B C#",
"B C# D# E F# G# A B C# D# E F# G# A B C# D# E F# G# A B C# D#",
"C D E F G A Bb C D E F G A Bb C D E F G A Bb C D E",
"D E F# G A B C D E F# G A B C D E F# G A B C D E F#",
"E F# G# A B C# D E F# G# A B C# D E F# G# A B C# D E F# G#",
"F G A Bb C D Eb F G A Bb C D Eb F G A Bb C D Eb F G A"
]]
]
;





// Audio:
// https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode/getByteFrequencyData
// https://stackoverflow.com/questions/28329389/is-there-a-way-to-detect-audio-frequency-in-html-5-web-audio-api


navigator.mediaDevices.getUserMedia({audio:true}).then(function(localStream) {

  var audioContext = new(window.AudioContext || window.webkitAudioContext)();
  
  var sampleRate = audioContext.sampleRate;
  console.log('sample rate = '+ sampleRate);
  
  
  // https://github.com/hughsk/clamp/blob/master/index.js [MIT license]
  function clamp(value, min, max) {
  return min < max
    ? (value < min ? min : value > max ? max : value)
    : (value < max ? max : value > min ? min : value)
  }
  
  // https://github.com/Jam3/audio-frequency-to-index/blob/master/index.js [MIT license]
  function indexToFrequency (index, sampleRate, frequencyBinCount) {
    return index * sampleRate / (frequencyBinCount * 2);
  }
  function frequencyToIndex (frequency, sampleRate, frequencyBinCount) { 
    var nyquist = sampleRate / 2;
    var index = Math.round(frequency / nyquist * frequencyBinCount);
    return clamp(index, 0, frequencyBinCount);
  }

  var input = audioContext.createMediaStreamSource(localStream);
  var scriptProcessor = audioContext.createScriptProcessor();
  
  var analyser = audioContext.createAnalyser();

  analyser.fftSize = 16384*2;

  input.connect(analyser);
  analyser.connect(scriptProcessor);
  scriptProcessor.connect(audioContext.destination);

  const frequencyBinCount = analyser.frequencyBinCount;
  console.log('frequencyBinCount = '+frequencyBinCount);
  
  var dataArray = new Uint8Array(frequencyBinCount*2);

  const drawscale = WIDTH/frequencyBinCount * magnify;
  const barWidth = drawscale ;
  console.log('barWidth = '+barWidth);

  
  function draw() {
    drawVisual = requestAnimationFrame(draw);

    analyser.getByteFrequencyData(dataArray);

    canvasCtx.fillStyle = "rgb(0, 0, 0)";
    canvasCtx.fillRect(0, 0, WIDTH*magnify, HEIGHT);

    // over limit area
    canvasCtx.fillStyle = "rgb(128, 128, 128)";
    if (freqs[freqs.length-1] > high_limit_hz) canvasCtx.fillStyle = "rgb(128, 0, 0)";  // warn over string limit
    var start_limit = drawscale*frequencyToIndex(high_limit_hz, sampleRate, frequencyBinCount)+barWidth*.5;
    canvasCtx.fillRect(start_limit, 0, WIDTH*magnify - start_limit, HEIGHT);
    
    // strings
    canvasCtx.fillStyle = "rgb(256, 256, 0)";
    for (let h = 0; h < freqs.length; h++) {
       canvasCtx.fillRect(drawscale*frequencyToIndex(freqs[h], sampleRate, frequencyBinCount), 0, barWidth*.5, HEIGHT);
    } 
   

    
    let barHeight;
    let x = 0;
    let mi = 0;
    let mv = 0;

    for (let i = 0; i < frequencyBinCount; i++) {
    
      barHeight = dataArray[i];
      if (barHeight>mv) {mv = barHeight;mi=i;}
    
      canvasCtx.fillStyle = `rgb(${barHeight + 100}, 200, 200)`;
      canvasCtx.fillRect(drawscale*i, HEIGHT - barHeight , barWidth, barHeight );

    }
    
  
    peakhz = Math.round(indexToFrequency(mi, sampleRate, frequencyBinCount));
    divloudestfreq.innerHTML = `${peakhz}`
  }

  changemode();
  draw();
 
});
 
 
 
</script>
</body></html>

